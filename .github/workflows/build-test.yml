name: Test Build

on:
    push:
         branches: [ 'master' ]
    pull_request:
         branches: [ 'develop' ]
    workflow_dispatch:

env:
    BUILD_TYPE: Debug

jobs:
    build:
        env:
            buildDir: '${{ github.workspace }}/build/'
        strategy:
            matrix:
                os: [ macos-10.15, windows-2019, ubuntu-18.04 ]
            fail-fast: false
        runs-on: ${{ matrix.os }}

        steps:
            -   uses: actions/checkout@v2
                with:
                    submodules: true
                    
            -   name: Create LFS file list
                run: git lfs ls-files -l | cut -d' ' -f1 | sort > .lfs-assets-id

            -   name: Restore LFS cache
                uses: actions/cache@v2
                id: lfs-cache
                with:
                 path: .git/lfs
                 key: ${{ runner.os }}-lfs-${{ hashFiles('.lfs-assets-id') }}-v1

            -   name: Checkout LFS objects
                run: git lfs pull

            -   uses: maxim-lobanov/setup-xcode@v1
                with:
                    xcode-version: '11.2.1'
                if: runner.os == 'macOS'

            -   name: Install tools on Ubuntu
                run: sudo apt-get install -y ninja-build build-essential libcurl4-openssl-dev
                if: runner.os == 'Linux'

            # Install latest CMake.
            -   uses: lukka/get-cmake@latest

            -   name: Set up Visual Studio shell
                if: runner.os == 'Windows'
                uses: egor-tensin/vs-shell@v2

            -   name: Build the project (Windows)
                if: runner.os == 'Windows'
                run: |
                    cmake -B build -G "Ninja"
                    cmake --build build

            -   name: Build the project
                if: runner.os != 'Windows'
                run: |
                    cmake -B build
                    cmake --build build
